<!-- 设备管理模态框 -->
<div x-show="activeModal === 'device'"
     x-cloak
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0"
     class="modal-backdrop">
  <div @click.away="closeModal()" @keydown.escape.window="closeModal()"
       x-transition:enter="transition ease-out duration-300"
       x-transition:enter-start="opacity-0 scale-95"
       x-transition:enter-end="opacity-100 scale-100"
       x-transition:leave="transition ease-in duration-200"
       x-transition:leave-start="opacity-100 scale-100"
       x-transition:leave-end="opacity-0 scale-95"
       class="modal-content device-modal__container">
    <div class="modal-form">
      <div class="modal-header">
        <div>
          <h2 class="modal-title">设备管理</h2>
          <p class="modal-subtitle">
            集中管理可接收提醒的推送设备，支持 Bark 和飞书机器人，默认设备会优先收到推送。
          </p>
        </div>
        <button type="button" class="modal-close" @click="closeModal()" aria-label="关闭">
          <span aria-hidden="true">×</span>
        </button>
      </div>

      <div class="modal-body device-modal__body">
        <section class="section-card device-modal__section">
          <div class="device-modal__heading">
            <div class="device-modal__heading-main">
              <div class="device-modal__icon">
                <svg class="device-modal__icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8"
                        d="M7 4h10a2 2 0 012 2v12a2 2 0 01-2 2H7a2 2 0 01-2-2V6a2 2 0 012-2z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8"
                        d="M9 8h6m-3 8h.01" />
                </svg>
              </div>
              <div>
                <h3 class="device-modal__title">已绑定的推送设备</h3>
                <p class="device-modal__desc">
                  MemoCue 会按照默认设备推送提醒，支持 Bark 和飞书等多种推送方式。
                </p>
              </div>
            </div>
            <div class="device-modal__metrics">
              <span class="device-modal__metrics-value" x-text="devices.length"></span>
              <span class="device-modal__metrics-label">已连接</span>
            </div>
          </div>

          <div x-show="devices.length" class="device-card-list" x-cloak>
            <template x-for="device in devices" :key="device.id">
              <div class="device-card"
                   :class="{'device-card--default': device.isDefault, 'device-card--editing': editingDevice && editingDevice.id === device.id}"
                   @click="editDevice(device)"
                   style="cursor: pointer; transition: all 0.2s ease;"
                   :style="editingDevice && editingDevice.id === device.id ? 'background: #f0f9ff; border-color: #3b82f6;' : ''">
                <div class="device-card__main">
                  <div class="device-card__avatar">
                    <span class="device-card__emoji" aria-hidden="true"
                          x-text="device.providerType === 'feishu' ? '🤖' : '📱'"></span>
                  </div>
                  <div class="device-card__info">
                    <div class="device-card__title">
                      <span x-text="device.name"></span>
                      <span x-show="device.isDefault" x-cloak class="badge badge-success device-card__badge">
                        默认设备
                      </span>
                    </div>
                    <div class="device-card__meta">
                      <span class="device-card__tag"
                            x-text="device.providerType === 'feishu' ? '飞书机器人' : 'Bark 推送'"></span>
                      <span x-show="device.isActive === false"
                            class="device-card__status device-card__status--offline">
                        未激活
                      </span>
                      <span x-show="device.isActive !== false"
                            class="device-card__status device-card__status--online">
                        已连接
                      </span>
                      <span x-show="device.lastTestAt"
                            class="device-card__status"
                            x-text="`上次测试 ${dayjs(device.lastTestAt).format('YYYY-MM-DD HH:mm')}`">
                      </span>
                    </div>
                  </div>
                </div>
                <div class="device-card__actions">
                  <button type="button" @click.stop="testDevice(device.id)"
                          class="device-card__button device-card__button--test">
                    测试
                  </button>
                  <button type="button" @click.stop="deleteDevice(device.id)"
                          class="device-card__button device-card__button--danger">
                    删除
                  </button>
                </div>
              </div>
            </template>
          </div>

          <div x-show="!devices.length" x-cloak class="empty-card device-modal__empty">
            <div class="empty-card__icon">
              <svg class="device-modal__empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8"
                      d="M7 4h10a2 2 0 012 2v9a2 2 0 01-2 2h-3l-2 3-2-3H7a2 2 0 01-2-2V6a2 2 0 012-2z" />
              </svg>
            </div>
            <div class="device-modal__empty-text">
              <h4 class="device-modal__empty-title">暂未添加设备</h4>
              <p class="device-modal__empty-desc">通过右侧表单添加第一台设备，MemoCue 会自动设为默认。</p>
            </div>
          </div>
        </section>

        <section class="section-card device-modal__section device-modal__form">
          <div class="device-modal__form-header">
            <h3 class="device-modal__form-title" x-text="editingDevice ? '编辑推送设备' : '添加推送设备'"></h3>
            <p class="device-modal__form-desc" x-text="editingDevice ?
              '修改设备配置信息。如需修改密钥等敏感信息，请留空表示不修改。' :
              '选择推送类型，填写相应配置即可完成绑定。首台设备会自动成为默认设备。'">
            </p>
          </div>
          <form @submit.prevent="saveDevice" class="device-modal__form-grid">
            <div class="form-field">
              <label class="label-modern">推送类型</label>
              <select x-model="deviceForm.providerType"
                      @change="onProviderTypeChange"
                      class="input-modern"
                      :disabled="editingDevice"
                      required>
                <option value="bark">Bark (iOS)</option>
                <option value="feishu">飞书机器人</option>
              </select>
              <p class="device-modal__hint" x-text="editingDevice ?
                '编辑模式下不能修改推送类型' :
                '选择您要使用的推送服务类型'"></p>
            </div>
            <div class="form-field">
              <label class="label-modern">设备名称</label>
              <input type="text" x-model="deviceForm.name" required
                     :placeholder="deviceForm.providerType === 'feishu' ? '飞书群机器人' : '我的 iPhone'"
                     class="input-modern">
              <p class="device-modal__hint" x-text="deviceForm.providerType === 'feishu' ?
                '给这个机器人起一个容易识别的名称' :
                '建议与 Bark 中的设备名称保持一致，方便识别。'"></p>
            </div>
            <!-- Bark 配置 -->
            <template x-if="deviceForm.providerType === 'bark'">
              <div class="form-field">
                <label class="label-modern">Bark 服务器</label>
                <input type="url" x-model="deviceForm.server"
                       :required="!editingDevice"
                       :placeholder="editingDevice ? '留空则不修改（需同时提供Key）' : 'https://api.day.app'"
                       class="input-modern">
                <p class="device-modal__hint" x-text="editingDevice ?
                  '如需修改服务器地址，请同时提供设备Key。留空则保持原配置。' :
                  '国内使用推荐保持默认服务器，需自建时填写自定义地址。'"></p>
              </div>
            </template>

            <template x-if="deviceForm.providerType === 'bark'">
              <div class="form-field">
                <label class="label-modern">设备 Key</label>
                <input type="text" x-model="deviceForm.key"
                       :required="!editingDevice"
                       :placeholder="editingDevice ? '留空则不修改' : '你的 Bark 设备 Key'"
                       class="input-modern">
                <p class="device-modal__hint" x-text="editingDevice ?
                  '如需修改配置，请同时提供服务器地址和Key。全部留空则保持原配置不变。' :
                  'Key 将加密存储，仅用于推送，不会泄露给第三方。'"></p>
              </div>
            </template>

            <!-- 飞书配置 -->
            <template x-if="deviceForm.providerType === 'feishu'">
              <div class="form-field">
                <label class="label-modern">Webhook URL</label>
                <input type="url" x-model="deviceForm.webhookUrl"
                       :required="!editingDevice"
                       :placeholder="editingDevice ? '留空则不修改' : 'https://open.feishu.cn/open-apis/bot/v2/hook/xxx'"
                       class="input-modern">
                <p class="device-modal__hint" x-text="editingDevice ?
                  '如需修改配置，必须提供Webhook URL。全部留空则保持原配置不变。' :
                  '在飞书群设置中添加机器人，复制 Webhook 地址填写到这里。'"></p>
              </div>
            </template>

            <template x-if="deviceForm.providerType === 'feishu'">
              <div class="form-field">
                <label class="label-modern">签名密钥（可选）</label>
                <input type="text" x-model="deviceForm.secret"
                       :placeholder="editingDevice ? '留空则不修改' : '如启用签名验证，请输入密钥'"
                       class="input-modern">
                <p class="device-modal__hint" x-text="editingDevice ?
                  '如修改配置需同时提供Webhook URL。密钥为选填项。' :
                  '如果在飞书中启用了签名验证，请输入对应的密钥，否则留空。'"></p>
              </div>
            </template>

            <template x-if="deviceForm.providerType === 'feishu'">
              <div class="form-field">
                <label class="label-modern">消息类型</label>
                <select x-model="deviceForm.messageType" class="input-modern">
                  <option value="auto">自动选择</option>
                  <option value="text">纯文本</option>
                  <option value="rich_text">富文本</option>
                  <option value="card">卡片消息</option>
                </select>
                <p class="device-modal__hint">卡片消息支持更丰富的展示效果和按钮操作。</p>
              </div>
            </template>
            <button type="submit" class="device-modal__submit"
                    :disabled="savingDevice"
                    :style="savingDevice ? 'opacity: 0.7; cursor: not-allowed;' : ''"
                    x-text="savingDevice ? '保存中...' : (editingDevice ? '更新设备' : '添加设备')">
            </button>
            <button type="button" x-show="editingDevice" x-cloak
                    @click="cancelEditDevice()"
                    :disabled="savingDevice"
                    class="device-modal__submit"
                    style="background: #6b7280; margin-top: 8px;">
              取消编辑
            </button>
          </form>
        </section>
      </div>

      <div class="modal-footer">
        <button type="button" class="modal-btn modal-btn--ghost" @click="closeModal()">
          关闭
        </button>
      </div>
    </div>
  </div>
</div>
