<!-- 任务编辑模态框 -->
<div x-show="activeModal === 'task'"
     x-cloak
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0"
     class="modal-backdrop">
  <div @click.away="closeModal()" @keydown.escape.window="closeModal()"
       x-transition:enter="transition ease-out duration-300"
       x-transition:enter-start="opacity-0 scale-95"
       x-transition:enter-end="opacity-100 scale-100"
       x-transition:leave="transition ease-in duration-200"
       x-transition:leave-start="opacity-100 scale-100"
       x-transition:leave-end="opacity-0 scale-95"
       class="modal-content">
    <form @submit.prevent="saveTask" class="modal-form">
      <div class="modal-header">
        <div>
          <h2 class="modal-title" x-text="editingTask ? '编辑提醒' : '新建提醒'"></h2>
          <p class="modal-subtitle">完善提醒的核心信息和调度策略，随时预览执行计划。</p>
        </div>
        <button type="button" class="modal-close" @click="closeModal()" aria-label="关闭">
          <span aria-hidden="true">×</span>
        </button>
      </div>

      <div class="modal-body modal-body--two-column">
        <div class="modal-column">
          <section class="section-card">
            <h3 class="section-title">基础信息</h3>
            <div class="form-stack">
              <div class="form-field">
                <label class="label-modern">
                  标题
                  <span class="text-xs text-gray-500 ml-2" x-text="`${UIUtils.getCharLength(taskForm.title)}/28`"></span>
                </label>
                <input type="text"
                       x-model="taskForm.title"
                       @input="taskForm.title = UIUtils.limitInputLength($event.target.value, 28)"
                       required
                       class="input-modern"
                       placeholder="输入提醒标题（最多14个汉字或28个字符）">
              </div>
              <div class="form-field">
                <label class="label-modern">内容</label>
                <textarea x-model="taskForm.content" rows="2"
                          class="input-modern textarea-modern"
                          placeholder="输入提醒内容（可选）"></textarea>
              </div>
              <div class="form-field">
                <label class="label-modern">推送设备</label>
                <select x-model="taskForm.deviceId" required
                        class="select-modern">
                  <option value="">选择设备</option>
                  <template x-for="device in devices" :key="device.id">
                    <option :value="device.id" x-text="device.name"></option>
                  </template>
                </select>
              </div>
              <div class="form-field">
                <label class="label-modern">分类</label>
                <select x-model="taskForm.categoryId" required
                        class="select-modern">
                  <template x-for="category in categories" :key="category.id">
                    <option :value="category.id" x-text="category.name"></option>
                  </template>
                </select>
              </div>
            </div>
          </section>
        </div>

        <div class="modal-column">
          <section class="section-card">
            <h3 class="section-title">时间安排</h3>
          <div class="form-grid">
            <div class="form-field form-field--full">
              <label class="label-modern">重复类型</label>
              <select x-model="taskForm.schedule.type"
                      @change="onScheduleTypeChange"
                      class="select-modern">
                <option value="once">单次</option>
                <option value="hourly">每小时</option>
                <option value="daily">每天</option>
                <option value="weekly">每周</option>
                <option value="monthly">每月</option>
                <option value="monthlyInterval">每N个月</option>
                <option value="cron">Cron表达式</option>
              </select>
            </div>
          </div>

          <div class="schedule-panels">
            <div class="schedule-panel" x-show="taskForm.schedule.type === 'once'">
              <label class="label-modern">执行时间</label>
              <input type="datetime-local" x-model="taskForm.schedule.datetime"
                     class="input-modern">

              <!-- 重复发送配置 -->
              <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                <div class="flex items-center gap-3 mb-3">
                  <input type="checkbox" x-model="taskForm.schedule.enableRepeat"
                         id="once-enable-repeat"
                         class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                  <label for="once-enable-repeat" class="text-sm font-medium text-gray-700">启用重复发送</label>
                </div>
                <div x-show="taskForm.schedule.enableRepeat" class="form-grid form-grid--split">
                  <div class="form-field">
                    <label class="text-xs text-gray-600">发送次数（1-10次）</label>
                    <input type="number" min="1" max="10" x-model="taskForm.schedule.repeatCount"
                           placeholder="发送次数"
                           class="input-modern">
                  </div>
                  <div class="form-field">
                    <label class="text-xs text-gray-600">间隔时间（1-60分钟）</label>
                    <input type="number" min="1" max="60" x-model="taskForm.schedule.repeatInterval"
                           placeholder="间隔分钟"
                           class="input-modern">
                  </div>
                </div>
              </div>
            </div>

            <div class="schedule-panel schedule-panel--compact" x-show="taskForm.schedule.type === 'hourly'">
              <div class="form-grid form-grid--compact">
                <div class="form-field">
                  <label class="text-sm text-gray-600">在每小时的第几分钟执行</label>
                  <input type="number" min="0" max="59" x-model="taskForm.schedule.minute"
                         placeholder="分钟 (0-59)"
                         class="input-modern">
                </div>
                <div class="form-field form-field--split">
                  <label class="text-sm text-gray-600">时间范围</label>
                  <div class="form-grid form-grid--split">
                    <input type="number" min="0" max="23" x-model="taskForm.schedule.startHour"
                           placeholder="开始时间 (0-23)"
                           class="input-modern">
                    <input type="number" min="0" max="23" x-model="taskForm.schedule.endHour"
                           placeholder="结束时间 (0-23)"
                           class="input-modern">
                  </div>
                  <p class="panel-note">留空表示全天执行</p>
                </div>
              </div>
            </div>

            <div class="schedule-panel" x-show="taskForm.schedule.type === 'daily'">
              <label class="label-modern">每天时间</label>
              <input type="time" x-model="taskForm.schedule.time"
                     class="input-modern">

              <!-- 重复发送配置 -->
              <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                <div class="flex items-center gap-3 mb-3">
                  <input type="checkbox" x-model="taskForm.schedule.enableRepeat"
                         id="daily-enable-repeat"
                         class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                  <label for="daily-enable-repeat" class="text-sm font-medium text-gray-700">启用重复发送</label>
                </div>
                <div x-show="taskForm.schedule.enableRepeat" class="form-grid form-grid--split">
                  <div class="form-field">
                    <label class="text-xs text-gray-600">发送次数（1-10次）</label>
                    <input type="number" min="1" max="10" x-model="taskForm.schedule.repeatCount"
                           placeholder="发送次数"
                           class="input-modern">
                  </div>
                  <div class="form-field">
                    <label class="text-xs text-gray-600">间隔时间（1-60分钟）</label>
                    <input type="number" min="1" max="60" x-model="taskForm.schedule.repeatInterval"
                           placeholder="间隔分钟"
                           class="input-modern">
                  </div>
                </div>
              </div>
            </div>

            <div class="schedule-panel" x-show="taskForm.schedule.type === 'weekly'">
              <label class="label-modern">每周时间</label>
              <div class="form-grid form-grid--split">
                <input type="time" x-model="taskForm.schedule.time"
                       class="input-modern">
                <div class="weekday-picker">
                  <template x-for="(day, index) in ['日', '一', '二', '三', '四', '五', '六']" :key="index">
                    <label class="weekday-pill" @click.prevent="toggleWeekday(index)">
                      <input type="checkbox"
                             :checked="taskForm.schedule.days && taskForm.schedule.days.includes(index)"
                             class="weekday-pill__input"
                             @click.stop>
                      <span x-text="day"></span>
                    </label>
                  </template>
                </div>
              </div>

              <!-- 重复发送配置 -->
              <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                <div class="flex items-center gap-3 mb-3">
                  <input type="checkbox" x-model="taskForm.schedule.enableRepeat"
                         id="weekly-enable-repeat"
                         class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                  <label for="weekly-enable-repeat" class="text-sm font-medium text-gray-700">启用重复发送</label>
                </div>
                <div x-show="taskForm.schedule.enableRepeat" class="form-grid form-grid--split">
                  <div class="form-field">
                    <label class="text-xs text-gray-600">发送次数（1-10次）</label>
                    <input type="number" min="1" max="10" x-model="taskForm.schedule.repeatCount"
                           placeholder="发送次数"
                           class="input-modern">
                  </div>
                  <div class="form-field">
                    <label class="text-xs text-gray-600">间隔时间（1-60分钟）</label>
                    <input type="number" min="1" max="60" x-model="taskForm.schedule.repeatInterval"
                           placeholder="间隔分钟"
                           class="input-modern">
                  </div>
                </div>
              </div>
            </div>

            <div class="schedule-panel" x-show="taskForm.schedule.type === 'monthly'">
              <label class="label-modern">每月日期和时间</label>
              <div class="form-grid form-grid--split">
                <input type="number" min="1" max="31" x-model="taskForm.schedule.day"
                       placeholder="日期 (1-31)"
                       class="input-modern">
                <input type="time" x-model="taskForm.schedule.time"
                       class="input-modern">
              </div>

              <!-- 重复发送配置 -->
              <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                <div class="flex items-center gap-3 mb-3">
                  <input type="checkbox" x-model="taskForm.schedule.enableRepeat"
                         id="monthly-enable-repeat"
                         class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                  <label for="monthly-enable-repeat" class="text-sm font-medium text-gray-700">启用重复发送</label>
                </div>
                <div x-show="taskForm.schedule.enableRepeat" class="form-grid form-grid--split">
                  <div class="form-field">
                    <label class="text-xs text-gray-600">发送次数（1-10次）</label>
                    <input type="number" min="1" max="10" x-model="taskForm.schedule.repeatCount"
                           placeholder="发送次数"
                           class="input-modern">
                  </div>
                  <div class="form-field">
                    <label class="text-xs text-gray-600">间隔时间（1-60分钟）</label>
                    <input type="number" min="1" max="60" x-model="taskForm.schedule.repeatInterval"
                           placeholder="间隔分钟"
                           class="input-modern">
                  </div>
                </div>
              </div>
            </div>

            <div class="schedule-panel schedule-panel--compact" x-show="taskForm.schedule.type === 'monthlyInterval'">
              <div class="form-grid form-grid--compact">
                <div class="form-field form-field--inline">
                  <div class="inline-pill">
                    <span class="inline-pill__prefix">每</span>
                    <input type="number" min="1" max="12" x-model="taskForm.schedule.interval"
                           class="input-modern inline-pill__input">
                    <span class="inline-pill__suffix">个月执行一次</span>
                    <span class="inline-pill__hint">可直接输入 1-12 的数字</span>
                  </div>
                </div>
                <div class="form-field form-field--split">
                  <label class="text-sm text-gray-600">首次执行日期和时间</label>
                  <div class="form-grid form-grid--split">
                    <input type="date" x-model="taskForm.schedule.firstDate"
                           max="2099-12-31"
                           @input="sanitizeDateInput('firstDate', false, $event)"
                           @blur="sanitizeDateInput('firstDate', true, $event)"
                           class="input-modern">
                    <input type="time" x-model="taskForm.schedule.time"
                           class="input-modern">
                  </div>
                  <p class="panel-note">选择第一次执行的完整日期，系统将基于此计算后续周期</p>
                </div>
              </div>
              <template x-if="taskForm.schedule.firstDate && taskForm.schedule.time && taskForm.schedule.interval">
                <div class="schedule-preview">
                  <p class="preview-title">💡 执行计划预览</p>
                  <div class="preview-items" x-html="previewMonthlySchedule()"></div>
                </div>
              </template>

              <!-- 重复发送配置 -->
              <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                <div class="flex items-center gap-3 mb-3">
                  <input type="checkbox" x-model="taskForm.schedule.enableRepeat"
                         id="monthlyInterval-enable-repeat"
                         class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                  <label for="monthlyInterval-enable-repeat" class="text-sm font-medium text-gray-700">启用重复发送</label>
                </div>
                <div x-show="taskForm.schedule.enableRepeat" class="form-grid form-grid--split">
                  <div class="form-field">
                    <label class="text-xs text-gray-600">发送次数（1-10次）</label>
                    <input type="number" min="1" max="10" x-model="taskForm.schedule.repeatCount"
                           placeholder="发送次数"
                           class="input-modern">
                  </div>
                  <div class="form-field">
                    <label class="text-xs text-gray-600">间隔时间（1-60分钟）</label>
                    <input type="number" min="1" max="60" x-model="taskForm.schedule.repeatInterval"
                           placeholder="间隔分钟"
                           class="input-modern">
                  </div>
                </div>
              </div>
            </div>

            <div class="schedule-panel" x-show="taskForm.schedule.type === 'cron'">
              <label class="label-modern">Cron 表达式</label>
              <input type="text" x-model="taskForm.schedule.expression"
                     placeholder="0 10 * * 1-5"
                     class="input-modern">
              <p class="panel-note">格式: 分 时 日 月 周</p>
            </div>
          </div>
          </section>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" @click="closeModal()"
                class="modal-btn modal-btn--ghost">
          取消
        </button>
        <button type="submit"
                class="modal-btn modal-btn--primary">
          保存
        </button>
      </div>
    </form>
  </div>
</div>
